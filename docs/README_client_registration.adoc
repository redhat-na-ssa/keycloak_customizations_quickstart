:scrollbar:
:data-uri:
:toc2:
:linkattrs:

= Dynamic Client Registration

:numbered:

== Quickstart Highlights

. Understand use case for Dynamic Client Registration
. Understand different implementation approaches for Dynamic Client Registration in RH-SSO

== Overview

=== Use Case

=== Goals
In this quickstart, a SSO client called _zyncsso_ will be configured with privildges to _manage-clients_ within the SSO realm.
Once created, this SSO client can facilitate the management of all other SSO clients within the realm.


=== Client Registration Providers
Red Hat SSO exposes a RESTful API that among other functions allows for the creation of SSO clients.
This API is called the _Client Registration Service_.

The RH-SSO Client Registration Service includes multiple implementations (aka: _providers_) as follows: 


[%header, cols="3,4,6"]
|===
|Provider Name
|Request Payload Format
|Notes
|default|RH-SSO Client Representation (JSON)|Use when your functionality to dynamically create clients will only need to work with RH-SSO.  RH-SSO Client Representation format provides support for configuring clients exactly as they can be configured through the admin console, including for example configuring protocol mappers.
|openid-connect|OIDC link:https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata[Client Metadata Description (JSON)]|Use when functionality to dynamically create clients needs to interoperate with multiple OIDC providers
|install|RH-SSO link:https://www.keycloak.org/docs/latest/securing_apps/#openid-connect[Client Adapter Configuration (JSON)]| Format used by _Keycloak OIDC client adapters_.
|saml2-entity-descriptor| SAML Entity Descriptor (XML)|
|===

The endpoint exposed by the Client Registration Service is as follows: 

-----
$RHSSO_URL/realms/<realm_name>/clients-regisrations/<provider name>
-----


== Dynamically Create Clients

=== As anonymous user

. Attempt to dynamically create a SSO client using the _default Keycloak Representations_  as an anonymous user :
+
-----
$ curl -v -X POST $RHSSO_URL/realms/$REALM_ID/clients-registrations/default \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"clientId\": \"default-anon-$RANDOM\", \"redirectUris\":[\"http://changeme:4080\", \"https://changemetoo:443\"],\"standardFlowEnabled\":\"true\", \"directAccessGrantsEnabled\":\"false\",  \"serviceAccountsEnabled\":\"false\", \"publicClient\":\"false\" }"


 ...

HTTP/1.1 403 Forbidden

{"error":"insufficient_scope","error_description":"Policy 'Trusted Hosts' rejected request to client-registration service. Details: URL doesn't match any trusted host or trusted domain"}
-----

. View configs for "Trusted Hosts"
+
-----
$ podman exec -it sso /opt/keycloak/bin/kcadm.sh get components -r ldap-demo -F "name,id,config(*)" -q name="Trusted Hosts"

[ {
  "id" : "439a5d2b-436f-43eb-a152-7edda257df14",
  "name" : "Trusted Hosts",
  "config" : {
    "host-sending-registration-request-must-match" : [ "false" ],
    "client-uris-must-match" : [ "true" ]
  }
} ]

-----

. Retry to POST to the _default Client Representation_ endpoint (as previous), but this time do so without specifying _redirectUris_ in the payload.  What are the results ?


=== As SSO Client with _manage-clients_ role
In this section, you will invoke the RH-SSO _/clients-registrations/default_ API using the _initial access token_ to create a new SSO client (called _zyncsso_ ).

This SSO client is configured with _manage-client_ privledges that subsequently allow it to create other SSO clients.


==== Verify ability to manage other SSO clients
. Return to the Admin Portal user interface of RHT-SSO
. Navigate to the _service account roles_ tab of the _zyncsso_ client.
. Notice the existance of the _manage-clients_ roles:
+
image::images/zync_assigned_roles.png[]


==== Create SSO Clients

. Acquire an access token from the _zyncsso_ client:
+
-----
$ ZYNCSSO_TKN=$(curl -X POST "$ACCESS_TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=zyncsso" \
            -d "client_secret=zyncsso" \
            -d "scope=openid" \
            | sed 's/.*access_token":"//g' | sed 's/".*//g')

echo $ZYNCSSO_TKN
-----

. Dynamically create a SSO client using the _default Keycloak Representations_ endpoint with the _zyncsso_ access token_ : 
+
-----
$ curl -v -X POST $RHSSO_URL/realms/$REALM_ID/clients-registrations/default \
    -H "Authorization: Bearer $ZYNCSSO_TKN" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"client_name\": \"oidc-manage-client-$RANDOM\", \"redirect_uris\":[\"http://changeme:4080\"] }" 

-----

. To create more SSO clients, you could continue to utilize $ZYNCSSO_TKN (until it expires in which case you need to acquire a new access token).  Try repeating the previous command a few times.  What are the results ?

=== Using _Initial_ and _Registration_ Access Tokens

==== Create Initial Access Token

To invoke either the _default_ or _openid-connect_ providers of Red Hat SSO _client registration service_ API, you need to use an  _Initial Access Token_.
In RH-SSO, an _Initial Access Token_ is configured at the _realm_ level (it's not associated with a SSO _client_ ) with an expiration time and maximum count of invocations.


This _Initial Access Token_ can be created as follows:


. Using _Resource Owner Password Credentials_ flow on the _admin-cli_ SSO client, acquire a OAuth2 Bearer Access Token: 
+
-----
ADMIN_API_TKN=$(curl -X POST "$ACCESS_TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=$REALM_ADMIN" \
            -d "password=$REALM_ADMIN_PASSWD" \
            -d "grant_type=password" \
            -d "client_id=admin-cli" \
            -d "scope=openid" \
            | sed 's/.*access_token":"//g' | sed 's/".*//g')

$ echo $ADMIN_API_TKN
-----

. Using the access token, invoke the _clients-initial-access_ API of RH-SSO to acquire an _initial access token_
+
-----
$ INITIAL_ACCESS_TOKEN=$(curl -X POST $RHSSO_URL/admin/realms/$REALM_ID/clients-initial-access \
    -d "{\"expiration\": 432000, \"count\": 10}" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -H "Authorization: Bearer $ADMIN_API_TKN" \
    | jq -r '.token' )
-----

==== Dynamically Create & Update SSO Client

. Generate a unique identifier for the client_id: 
+
-----
$ CLIENT_ID=default-initial-reg-$RANDOM
-----

. Dynamically create a SSO client using the _openid-connect_ endpoint with the _initial access token_ : 
+
-----
$ ZYNC_SSO_CLIENT_REG_ACCESS_TOKEN=$( curl -X POST $RHSSO_URL/realms/$REALM_ID/clients-registrations/default \
    -H "Authorization: Bearer $INITIAL_ACCESS_TOKEN" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"clientId\": \"$CLIENT_ID\", \"redirectUris\":[\"http://changeme:4080\", \"https://changeme:443\"],\"standardFlowEnabled\":\"true\", \"directAccessGrantsEnabled\":\"false\",  \"serviceAccountsEnabled\":\"false\", \"publicClient\":\"false\" }" \
    | jq -r .registrationAccessToken  )
-----

. View the newly generated _Registration Access Token_: 
+
-----
$ echo $ZYNC_SSO_CLIENT_REG_ACCESS_TOKEN
-----

. Dynamically create a SSO client using the _openid-connect_ endpoint with the _registration access token_ : 
+
-----
$ ZYNC_SSO_CLIENT_REG_ACCESS_TOKEN=$( curl -X PUT $RHSSO_URL/realms/$REALM_ID/clients-registrations/default/$CLIENT_ID \
    -H "Authorization: Bearer $ZYNC_SSO_CLIENT_REG_ACCESS_TOKEN" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"clientId\": \"$CLIENT_ID\", \"redirectUris\":[\"http://ichangedyou:4080\", \"https://ichangedyou:443\"],\"standardFlowEnabled\":\"true\", \"directAccessGrantsEnabled\":\"false\",  \"serviceAccountsEnabled\":\"false\", \"publicClient\":\"false\" }" \
    | jq -r .registrationAccessToken  )
-----

. Return to the console of the _ldap-demo_ realm and notice the updated _redirect URIs_ on your dynamically generated SSO client: 
+
image::images/client_reg_update.png[]


== Reference

. link:https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.6/html-single/securing_applications_and_services_guide/index#client_registration[Using RH-SSO Client Registration Services]
. link:https://openid.net/specs/openid-connect-registration-1_0.html[OIDC Dynamic Client Registration 1.0]
. link:https://openid.net/wordpress-content/uploads/2018/06/OpenID-Connect-Conformance-Profiles.pdf[Dynamic OIDC provider certification, Section 2.2.5]
. link:https://datatracker.ietf.org/doc/html/rfc7591[OAuth2 Dynamic Client Registration Protocol]
. link:https://datatracker.ietf.org/doc/html/rfc7592[OAuth2 Dynamic Client Registration Management Protocol]


