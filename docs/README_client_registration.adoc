:scrollbar:
:data-uri:
:toc2:
:linkattrs:

= Dynamic Client Registration

:numbered:

== Quickstart Highlights

. Understand use case for Dynamic Client Registration
. Understand different implementation approaches for Dynamic Client Registration in RH-SSO

== Overview

=== Use Case

=== Goals
In this quickstart, a SSO client called _zyncsso_ will be configured with privildges to _manage-clients_ within the SSO realm.
Once created, this SSO client can facilitate the management of all other SSO clients within the realm.


=== Client Registration Providers
Red Hat SSO exposes a RESTful API that among other functions allows for the creation of SSO clients.
This API is called the _Client Registration Service_.

The RH-SSO Client Registration Service includes multiple implementations (aka: _providers_) as follows: 


[%header, cols="3,4,6"]
|===
|Provider Name
|Request Payload Format
|Notes
|default|RH-SSO Client Representation (JSON)|Use when your functionality to dynamically create clients will only need to work with RH-SSO.  RH-SSO Client Representation format provides support for configuring clients exactly as they can be configured through the admin console, including for example configuring protocol mappers.
|openid-connect|OIDC link:https://openid.net/specs/openid-connect-registration-1_0.html#ClientMetadata[Client Metadata Description (JSON)]|Use when functionality to dynamically create clients needs to interoperate with multiple OIDC providers
|install|RH-SSO link:https://www.keycloak.org/docs/latest/securing_apps/#openid-connect[Client Adapter Configuration (JSON)]| Format used by _Keycloak OIDC client adapters_.
|saml2-entity-descriptor| SAML Entity Descriptor (XML)|
|===

The endpoint exposed by the Client Registration Service is as follows: 

-----
$RHSSO_URL/realms/<realm_name>/clients-regisrations/<provider name>
-----


== Dynamically Create Clients

=== Anonymous

. Seems that Client Registration Service is allowing for creation of clients without event including a Client Registration Access Token: 
+
-----
$ curl -v -X POST $RHSSO_URL/realms/$REALM_ID/clients-registrations/default \
    -H "Authorization: Bearer $INITIAL_ACCESS_TOKEN" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"clientId\": \"default-$RANDOM\", \"redirectUris\":[\"http://changeme:4080\", \"https://changemetoo:443\"],\"standardFlowEnabled\":\"true\", \"directAccessGrantsEnabled\":\"false\",  \"serviceAccountsEnabled\":\"false\", \"publicClient\":\"false\" }"
-----

=== SSO Client with _manage-clients_ role
In this section, you will invoke the RH-SSO _/clients-registrations/default_ API using the _initial access token_ to create a new SSO client (called _zyncsso_ ).

This SSO client is configured with _manage-client_ privledges that subsequently allow it to create other SSO clients.


==== Verify ability to manage other SSO clients
. Return to the Admin Portal user interface of RHT-SSO
. Navigate to the _service account roles_ tab of the _zyncsso_ client.
. Notice the existance of the _manage-clients_ roles:
+
image::images/zync_assigned_roles.png[]


==== Create SSO Clients

. Acquire an access token from the _zyncsso_ client:
+
-----
$ ZYNCSSO_TKN=$(curl -X POST "$ACCESS_TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=zyncsso" \
            -d "client_secret=zyncsso" \
            -d "scope=openid" \
            | sed 's/.*access_token":"//g' | sed 's/".*//g')

echo $ZYNCSSO_TKN
-----

. Dynamically create a SSO client using the _default Keycloak Representations_ endpoint with the _zyncsso_ access token_ : 
+
-----
$ curl -v -X POST $RHSSO_URL/realms/$REALM_ID/clients-registrations/default \
    -H "Authorization: Bearer $ZYNCSSO_TKN" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"clientId\": \"default-manage-client-$RANDOM\", \"redirectUris\":[\"http://changeme:4080\", \"https://changemetoo:443\"],\"standardFlowEnabled\":\"true\", \"directAccessGrantsEnabled\":\"false\",  \"serviceAccountsEnabled\":\"false\", \"publicClient\":\"false\" }"
-----

To create more SSO clients, you could continue to utilize $ZYNCSSO_TKN (until it expires in which case you need to acquire a new access token).

=== _Initial_ and _Registration_ Access Tokens

==== Create Initial Access Token

Creation of the _zyncsso_ client will occur by invoking the _default_ provider of RH-SSO's _client registration service_ API.

To invoke either the _default_ or _openid-connect_ providers of Red Hat SSO _client registration service_ API, you need to use an  _Initial Access Token_.
In RH-SSO, an _Initial Access Token_ is configured at the _realm_ level (it's not associated with a SSO _client_ ) with an expiration time and maximum count of invocations.


This _Initial Access Token_ can be created as follows:


. Using _Resource Owner Password Credentials_ flow on the _admin-cli_ SSO client, acquire a OAuth2 Bearer Access Token: 
+
-----
ADMIN_API_TKN=$(curl -X POST "$ACCESS_TOKEN_URL" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "username=$REALM_ADMIN" \
            -d "password=$REALM_ADMIN_PASSWD" \
            -d "grant_type=password" \
            -d "client_id=admin-cli" \
            -d "scope=openid" \
            | sed 's/.*access_token":"//g' | sed 's/".*//g')

$ echo $ADMIN_API_TKN
-----

. Using the access token, invoke the _clients-initial-access_ API of RH-SSO to acquire an _initial access token_
+
-----
$ INITIAL_ACCESS_TOKEN=$(curl -X POST $RHSSO_URL/admin/realms/$REALM_ID/clients-initial-access \
    -d "{\"expiration\": 432000, \"count\": 1}" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -H "Authorization: Bearer $ADMIN_API_TKN" \
    | jq -r '.token'
    )
-----

==== Dynamically Create SSO Clients

. Dynamically create a SSO client using the _openid-connect_ endpoint with the _initial access token_ : 
+
-----
$ ZYNC_SSO_CLIENT_REG_ACCESS_TOKEN=$( curl -v -X POST $RHSSO_URL/realms/$REALM_ID/clients-registrations/openid-connect \
    -H "Authorization: Bearer $INITIAL_ACCESS_TOKEN" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"client_name\": \"oidc-initial-token-$RANDOM\", \"redirect_uris\":[\"http://changeme:4080\"] }" \
    | jq -r .registrationAccessToken
  ) 
-----

. Dynamically create a SSO client using the _openid-connect_ endpoint with the _registration access token_ : 
+
-----
$ ZYNC_SSO_CLIENT_REG_ACCESS_TOKEN=$( curl -v -X POST $RHSSO_URL/realms/$REALM_ID/clients-registrations/openid-connect \
    -H "Authorization: Bearer $ZYNC_SSO_CLIENT_REG_ACCESS_TOKEN" \
    -H "Content-Type:application/json" \
    -H "Accept: application/json" \
    -d "{ \"client_name\": \"oidc-initial-token-$RANDOM\", \"redirect_uris\":[\"http://changeme:4080\"] }" \
    | jq -r .registrationAccessToken
  )
    
-----


== Reference

. link:https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.6/html-single/securing_applications_and_services_guide/index#client_registration[Using RH-SSO Client Registration Services]
. link:https://openid.net/specs/openid-connect-registration-1_0.html[OIDC Dynamic Client Registration 1.0]
. link:https://openid.net/wordpress-content/uploads/2018/06/OpenID-Connect-Conformance-Profiles.pdf[Dynamic OIDC provider certification, Section 2.2.5]
. link:https://datatracker.ietf.org/doc/html/rfc7591[OAuth2 Dynamic Client Registration Protocol]
. link:https://datatracker.ietf.org/doc/html/rfc7592[OAuth2 Dynamic Client Registration Management Protocol]


