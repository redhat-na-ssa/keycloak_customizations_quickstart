:scrollbar:
:data-uri:
:toc2:
:linkattrs:

= Federation & Identity Brokering

The purpose of this quickstart is to demonstrate OpenID Connect (OIDC) based security where the system of record of user and role data is maintained in external identity providers.

NOTE:  Using keycloak 19.0.1, this lab is currently broken when sso realm admin navigates to `User Federation` tab of realm.  Response from the following seems to be OK:  http://sso.local:4080/admin/realms/kc-demo/components?parentId=kc-demo&type=org.keycloak.storage.UserStorageProvider .  However, there is a javascript error:  Cannot read properties of undefined (reading '0')

link:https://keycloak.discourse.group/t/error-when-configuring-conditional-step/18117/2[Temporary Workaround] until apparent fix in keycloak 20.

:numbered:

== Quickstart Highlights

. *User Synch Strategies*

. *User Federation_ Strategies*
+
The system of record of user identity is maintained in an `openldap` database.
In addition, the _WRITABLE_ strategy (provided as part of the integration between RH-SSO and ldap) can be used to replicate any changes made to federated user data in RH-SSO back to the LDAP directory.

. *Broker Federation using RH-SSO and Github*

== User Federation Synch

image::images/periodic_sync_setting.png[]

== User Federation Strategies

NOTE:  Change this lab such that jbrown user is given `account` client related roles.

This quickstart includes _User Federation_ configs to synchronize user data between RH-SSO and OpenLDAP.

This User Federation config specifies a _READ_ONLY_ strategy for synchronizing that user data:  user data will be pulled into RH-SSO but if/when that user data in RH-SSO changes, those changes will not be propogated back to OpenLDAP.

Details regarding the various synchronization strategies supported in RH-SSO can be found in the section _Integrating with LDAP and Active Directory_ of link:https://smile.amazon.com/Keycloak-Management-Applications-protocols-applications/dp/1800562497[Keycloak - Identity & Access Management for Modern Apps] book.

In this section of the lab, you will modify the synchronization strategy to allow changes of user data in RH-SSO to propogate to LDAP.


=== Change synchronization to: Writable
. Your SSO Realm includes a _User Federation_ config called:  `ldap-apacheds`.
. In the _kc-demo_ realm of RH-SSO, navigate to: `User Federation -> ldap-apacheds -> edit`
+
image::images/edit_user_federation.png[]

. Switch the _Edit Mode_ to:  `WRITEABLE`.
. Click `Save`


=== Test synchronization to LDAP

. In the _kc-demo_ realm, add a new realm role called:  _new_role_ 
+
Roles -> Add Role -> Role Name -> _new_role_

. Assocate the _new_role_ role with the _jbrown_ user:
+
Users -> _jbrown_ -> Role Mappings -> Assigned Roles -> _new_role_
+
image::images/new_role_added.png[]

. Execute the following to verify that the new role was synced to the remote ldap: 
+
-----
$ ldapsearch -x \
             -h localhost \
             -p 3389 \
             -b cn=new_role,ou=RealmRoles,dc=example,dc=org \
             -D "cn=admin,dc=example,dc=org" \
             -w admin
-----


. The response should include the following:app-name:
+
-----

...

# new_role, RealmRoles, example.org
dn: cn=new_role,ou=RealmRoles,dc=example,dc=org
objectClass: groupOfNames
cn: new_role
member: cn=empty-membership-placeholder
member: uid=jbrown,ou=People,dc=example,dc=org

...

-----


== RH-SSO as an Identity Broker
Keycloak can integrate w/ 3rd party identity providers using a set of open standard protocols.  In particular, Keycloak can act as an intermediary service for authenticating and replicating users from a targeted identity provider.

In this section of the quickstart, _github_ will be used as that targeted identity provider and the protocol used to facilitate that integration will be OpenID Connect.

=== Benefits
Through identity brokering, you can provide a much better experience for users where they can leverage an existing account to authenticate and sign up in your realm.

Once these users have been created and their information has been imported from the third-party provider, they become users of your realm and can enjoy all of the features provided by Keycloak and respect the security constraints imposed by your realm.

=== github OAuth App

In this section, you will create a new OAuth client in github.

. Authenticate into github and navigate to:  `Settings -> Developer settings`.
. Click the `New OAuth App` button.
. Populate the form with the following values:app-name:
.. *Application name* : `external-idp-test`
.. *Homepage URL*: `https://github.com/redhat-na-ssa/keycloak_ldap_quickstart`
.. *Authorization callback URL*:  `http://sso.local:4080`
. Click `Register application`
. In the details page of the new github OAuth App, copy both the `Client ID` as well as the `client secret`
+
image::images/external-idp-settings.png[]


==== RH-SSO: github Identity Provider

. Modify both the `Client Id` as well as the `Client Secret` with the values provided in the github OAuth App
+
image::images/rhsso_github_idp.png[]

. Click `Save`



==== github OAuth App

In this section, you will create a new OAuth client in github.

. Authenticate into github and navigate to:  `Settings -> Developer settings`.
. Click the `New OAuth App` button.
. Populate the form with the following values:app-name:
.. *Application name* : `external-idp-test`
.. *Homepage URL*: `https://github.com/redhat-na-ssa/keycloak_ldap_quickstart`
.. *Authorization callback URL*:  `http://sso.local:4080`
. Click `Register application`
. In the details page of the new github OAuth App, copy both the `Client ID` as well as the `client secret`
+
image::images/external-idp-settings.png[]


==== RH-SSO: github Identity Provider

. Modify both the `Client Id` as well as the `Client Secret` with the values provided in the github OAuth App
+
image::images/rhsso_github_idp.png[]

. Click `Save`


== Reference

. https://github.com/keycloak/keycloak/tree/main/examples/ldap
